var async   = require('async');
var express = require('express');
var util    = require('util');
var lastfm  = require('lastfm');

var DEV = false;
var apiKey = DEV ? "74b103511369671daf6df03945cee796" : "9c5df33c08281a3dbd68378f4027728e";
var apiSecret = DEV ? "47f5770005bf9795612fd321abd8bcf8" : "6bc5cbaeef943d1ac2f84dfba8b51447";
lastfm = new lastfm.LastFM(apiKey, apiSecret);

var APP = {
  name: "Gig.fm",
  url: "http://www.gigfm.net", //"https://gigfm.herokuapp.com",
  img: "http://www.gigfm.net/images/logo-box.png",
  desc: "Gig.fm automatically generates a Youtube playlist for each upcoming concert that matches your musical preferences, in your city. It's a great way to discover new bands, and see them on stage!",
  fbPage: "https://www.facebook.com/pages/Gigfm/454214504613634",
  twitterHandle: "gigfm_net"
};

// create an express webserver
var app = express.createServer(
  express.logger(),
  express.static(__dirname + '/public'),
  express.bodyParser(),
  express.cookieParser(),
  // set this to a secret value to encrypt session cookies
  express.session({ secret: process.env.SESSION_SECRET || 'secret123' })
);

// listen to the PORT given to us in the environment
var port = process.env.PORT || 3000;

app.listen(port, function() {
  console.log("Listening on " + port);
});

app.dynamicHelpers({
  'host': function(req, res) {
    return req.headers['host'];
  },
  'scheme': function(req, res) {
    req.headers['x-forwarded-proto'] || 'http'
  },
  'url': function(req, res) {
    return function(path) {
      return app.dynamicViewHelpers.scheme(req, res) + app.dynamicViewHelpers.url_no_scheme(path);
    }
  },
  'url_no_scheme': function(req, res) {
    return function(path) {
      return '://' + app.dynamicViewHelpers.host(req, res) + path;
    }
  },
});

function renderAppPage(req, res, template, p) {
  var p = p || {};
  p.app = APP;
  p.layout = false;
  p.req = req;
  p.user = {
    name: (req.cookies || {}).gigfm_user || "James Garett",
    img: (req.cookies || {}).gigfm_uimg || "/images/avatar-1.png"
  }
  res.render(template, p);
}

function makeRenderer(template, p) {
  return function (req, res) {
    if (p && typeof p == "function")
      p(req, function(p) {
        renderAppPage(req, res, template, p);
      });
    else
      renderAppPage(req, res, template, p);
  }
}

app.get('/demo', function(req, res) {
  res.cookie("gigfm_sk", "");
  res.cookie("gigfm_user", "");
  res.cookie("gigfm_uimg", "");
  renderAppPage(req, res, "index.ejs", {
    loginUrl: "/gigs"
  });
});

app.get('/', makeRenderer("index.ejs", {
  loginUrl: "https://www.last.fm/api/auth/?api_key=" + apiKey
}));

app.get('/about', makeRenderer("about.ejs"));

app.get('/lastfmCallback', function(req, res) {
  lastfm.fetchSession(req.query["token"], function(session){
    res.cookie("gigfm_sk", session.key);
    res.cookie("gigfm_user", session.name);
    lastfm.getUserInfo(session.name, function(user){
      console.log("user", user);
      if (user && user.image)
        res.cookie("gigfm_uimg", user.image[0]["#text"]);
      res.redirect('/gigs');
      //res.redirect('/gigs?user='+session.name+'&sk='+session.key);
    });
  });
});

var sampleGigs = {"events":{"event":[{"id":"3319692","title":"The Ophidian Trek Tour","score":"0.083450219419542","artists":{"artist":["Meshuggah","Decapitated","C.B Murdoc"],"headliner":"Meshuggah"},"venue":{"id":"8778673","name":"Bataclan","location":{"geo:point":{"geo:lat":"48.863113","geo:long":"2.371051"},"city":"Paris","country":"France","street":"50, boulevard Voltaire","postalcode":"75011"},"url":"http://www.last.fm/venue/8778673+Bataclan","website":"http://www.le-bataclan.com","phonenumber":"+ 33 1 43 14 00 30","image":[{"#text":"http://userserve-ak.last.fm/serve/34/2152188.jpg","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/2152188.jpg","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/2152188.jpg","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/2152188.jpg","size":"extralarge"},{"#text":"http://userserve-ak.last.fm/serve/_/2152188/Bataclan.jpg","size":"mega"}]},"startDate":"Sun, 02 Dec 2012 17:30:01","description":"","image":[{"#text":"http://userserve-ak.last.fm/serve/34/76714154.png","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/76714154.png","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/76714154.png","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/76714154.png","size":"extralarge"}],"attendance":"63","reviews":"0","tag":"lastfm:event=3319692","url":"http://www.last.fm/event/3319692+The+Ophidian+Trek+Tour","website":"","tickets":"\n  ","cancelled":"0","tags":{"tag":["death metal","progressive metal"]},"@attr":{"status":"2"}},{"id":"3416593","title":"God Is an Astronaut","score":"0.14976763138947","artists":{"artist":"God Is an Astronaut","headliner":"God Is an Astronaut"},"venue":{"id":"9062856","name":"Glazart","location":{"geo:point":{"geo:lat":"48.899382","geo:long":"2.386851"},"city":"Paris","country":"France","street":"7/15 avenue de la Porte de la Villette","postalcode":"75019"},"url":"http://www.last.fm/venue/9062856+Glazart","website":"http://www.glazart.com","phonenumber":"01 40 36 55 65","image":[{"#text":"http://userserve-ak.last.fm/serve/34/34078787.png","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/34078787.png","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/34078787.png","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/34078787.png","size":"extralarge"},{"#text":"http://userserve-ak.last.fm/serve/_/34078787/Glazart.png","size":"mega"}]},"startDate":"Tue, 04 Dec 2012 19:30:00","description":"","image":[{"#text":"http://userserve-ak.last.fm/serve/34/44093839.jpg","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/44093839.jpg","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/44093839.jpg","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/44093839.jpg","size":"extralarge"}],"attendance":"79","reviews":"0","tag":"lastfm:event=3416593","url":"http://www.last.fm/event/3416593+God+Is+an+Astronaut+at+Glazart+on+4+December+2012","website":"","tickets":"\n  ","cancelled":"0","tags":{"tag":["ambient","post-rock","post rock","instrumental"]},"@attr":{"status":"2"}},{"id":"3418306","title":"Snarky Puppy","score":"0.017025691093074","artists":{"artist":["Snarky Puppy","Electro Deluxe"],"headliner":"Snarky Puppy"},"venue":{"id":"8785936","name":"New Morning","location":{"geo:point":{"geo:lat":"48.87321","geo:long":"2.352943"},"city":"Paris","country":"France","street":"7, rue des Petites Ecuries","postalcode":"75010"},"url":"http://www.last.fm/venue/8785936+New+Morning","website":"http://www.newmorning.com/","phonenumber":"01.45.23.51.41","image":[{"#text":"http://userserve-ak.last.fm/serve/34/385199.jpg","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/385199.jpg","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/385199.jpg","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/385199.jpg","size":"extralarge"},{"#text":"http://userserve-ak.last.fm/serve/_/385199/New+Morning.jpg","size":"mega"}]},"startDate":"Tue, 04 Dec 2012 20:30:00","description":"<div class=\"bbcode\">Plus qu’un concert c’est une véritable rencontre que propose Electro Deluxe pour cette soirée unique avec le groupe américain Snarky Puppy. Le combo français invite un des groupes les plus innovants de la scène jazz U.S. pour un moment musical rare.<br /><br />Electro Deluxe dévoilera pour l’occasion un répertoire en grande partie rafraichi par de toutes nouvelles compositions. Le groupe présentera également une formation enrichie par l’arrivée d’un trombone dans la section cuivres. La solide section rythmique, l’énergie contagieuse du chanteur James Copley et les rafales de cuivres constituent toujours les principaux ingrédients de la recette proposée par ce groupe qui conjugue soul, funk et jazz et electro.<br /><br />Les américains de Snarky Puppy, trop rares en France, viendront distiller leur musique inventive au groove irrésistible servie par des compositions soignées et des solistes inspirés. Il a fallu seulement 3 albums et des vidéos devenues célèbres sur internet pour que le groupe américain se fasse une place sur la scène musicale internationale. Il est aujourd’hui le digne héritier de Weather Report ou des Headhunters et perpétue la tradition en l’animant d’une flamme résolument actuelle.<br /><br />Ce trait d’union entre les 2 groupes semblait comme une évidence, c’est désormais chose faite grâce à cette rencontre exceptionnelle et à ce double concert qui fera date.</div>","image":[{"#text":"http://userserve-ak.last.fm/serve/34/75674268.jpg","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/75674268.jpg","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/75674268.jpg","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/75674268.jpg","size":"extralarge"}],"attendance":"5","reviews":"0","tag":"lastfm:event=3418306","url":"http://www.last.fm/event/3418306+Snarky+Puppy+at+New+Morning+on+4+December+2012","website":"","tickets":"\n  ","cancelled":"0","tags":{"tag":["jazz","electronic","gimme sum friends04","electro jazz","acid jazz","gimme sum friends","fusion"]},"@attr":{"status":"2"}},{"id":"3409698","title":"Yeasayer","score":"0.4750301753304","artists":{"artist":["Yeasayer","SX"],"headliner":"Yeasayer"},"venue":{"id":"9166872","name":"La Gaîté Lyrique","location":{"geo:point":{"geo:lat":"48.866846","geo:long":"2.353595"},"city":"Paris","country":"France","street":"3bis rue Papin","postalcode":"75003"},"url":"http://www.last.fm/venue/9166872+La+Ga%C3%AEt%C3%A9+Lyrique","website":"http://www.gaite-lyrique.net","phonenumber":"+33-(0)1-44 78 84 22","image":[{"#text":"http://userserve-ak.last.fm/serve/34/57380185.jpg","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/57380185.jpg","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/57380185.jpg","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/57380185.jpg","size":"extralarge"},{"#text":"http://userserve-ak.last.fm/serve/500/57380185/La+Gat+Lyrique+12052010074443.jpg","size":"mega"}]},"startDate":"Fri, 07 Dec 2012 20:00:00","description":"","image":[{"#text":"http://userserve-ak.last.fm/serve/34/70850760.png","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/70850760.png","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/70850760.png","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/70850760.png","size":"extralarge"}],"attendance":"43","reviews":"0","tag":"lastfm:event=3409698","url":"http://www.last.fm/event/3409698+Yeasayer+at+La+Ga%C3%AEt%C3%A9+Lyrique+on+7+December+2012","website":"","tickets":"\n  ","cancelled":"0","tags":{"tag":["indie","electronic","experimental","indie rock","psychedelic"]},"@attr":{"status":"2"}},{"id":"3447286","title":"DFA Night ","score":"0.23255133514981","artists":{"artist":["Juan Maclean","Mock & Toof","Nancy Whang","Pat Mahoney"],"headliner":"Juan Maclean"},"venue":{"id":"9104998","name":"La Machine du Moulin Rouge","location":{"geo:point":{"geo:lat":"48.884008","geo:long":"2.332258"},"city":"Paris","country":"France","street":"90, boulevard de Clichy","postalcode":"75018"},"url":"http://www.last.fm/venue/9104998+La+Machine+du+Moulin+Rouge","website":"http://www.lamachinedumoulinrouge.com","phonenumber":"+33-(0)1-53418888","image":[{"#text":"http://userserve-ak.last.fm/serve/34/42932337.png","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/42932337.png","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/42932337.png","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/42932337.png","size":"extralarge"},{"#text":"http://userserve-ak.last.fm/serve/_/42932337/La+Machine+du+Moulin+Rouge+header2.png","size":"mega"}]},"startDate":"Fri, 07 Dec 2012 23:00:00","description":"<div class=\"bbcode\">Après avoir hébergé LCD Soundsystem, sorti le dernier album de The Rapture ou abrité Shit Robot, le mythique label DFA vous propose de terminer la saison à La Machine avec ses meilleurs djs !! Attention, date unique en France !<br /><br />Chacun a tourné dans les meilleurs clubs du monde et, pour la première fois, ils sont réunis sur un plateau DFA !<br /><br />15€ en prévente (hors frais de location) - 18€ sur place</div>","image":[{"#text":"http://userserve-ak.last.fm/serve/34/51171097.jpg","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/51171097.jpg","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/51171097.jpg","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/51171097.jpg","size":"extralarge"}],"attendance":"2","reviews":"0","tag":"lastfm:event=3447286","url":"http://www.last.fm/event/3447286+DFA+Night+","website":"http://www.lamachinedumoulinrouge.com/dfa-night-juan-maclean-pat-mahoney-nancy-wang-mock-toof","tickets":"\n  ","cancelled":"0","tags":{"tag":["house","electronic"]},"@attr":{"status":"2"}},{"id":"3381281","title":"Stars","score":"0.07526797850107","artists":{"artist":"Stars","headliner":"Stars"},"venue":{"id":"8779401","name":"La Maroquinerie","location":{"geo:point":{"geo:lat":"48.868348","geo:long":"2.392217"},"city":"Paris","country":"France","street":"23 Rue Boyer","postalcode":"75020"},"url":"http://www.last.fm/venue/8779401+La+Maroquinerie","website":"http://www.lamaroquinerie.fr","phonenumber":"+33-(0)1-40333505","image":[{"#text":"http://userserve-ak.last.fm/serve/34/5492666.png","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/5492666.png","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/5492666.png","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/5492666.png","size":"extralarge"},{"#text":"http://userserve-ak.last.fm/serve/_/5492666/La+Maroquinerie+Marok.png","size":"mega"}]},"startDate":"Sat, 08 Dec 2012 19:30:00","description":"<div class=\"bbcode\"><a href=\"http://www.avosbillets.com/page/9790/stars\" rel=\"nofollow\">A vos Billets</a></div>","image":[{"#text":"http://userserve-ak.last.fm/serve/34/36564.jpg","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/36564.jpg","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/36564.jpg","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/36564.jpg","size":"extralarge"}],"attendance":"37","reviews":"0","tag":"lastfm:event=3381281","url":"http://www.last.fm/event/3381281+Stars+at+La+Maroquinerie+on+8+December+2012","website":"http://www.youarestars.com","tickets":"\n  ","cancelled":"0","tags":{"tag":["canadian","indie","indie pop"]},"@attr":{"status":"2"}},{"id":"3440164","title":"The Prestige","score":"0.26513249971533","artists":{"artist":["The Prestige","Lab°","Dysfunctional by Choice"],"headliner":"The Prestige"},"venue":{"id":"10281461","name":"La Clef","location":{"geo:point":{"geo:lat":"48.893551","geo:long":"2.088175"},"city":"St-Germain en Laye","country":"France","street":"","postalcode":""},"url":"http://www.last.fm/venue/10281461+La+Clef","website":"","phonenumber":"","image":[{"#text":"","size":"small"},{"#text":"","size":"medium"},{"#text":"","size":"large"},{"#text":"","size":"extralarge"},{"#text":"","size":"mega"}]},"startDate":"Sat, 08 Dec 2012 20:00:00","description":"<div class=\"bbcode\">LAB incarne encore et toujours le parfait exemple de l'originalité musicale. Sur scène, leur quête d'une esthétique pure enveloppe chaque spectateur dans un espace sonore multidimensionnel à forte sensibilité. Sans détour!</div>","image":[{"#text":"http://userserve-ak.last.fm/serve/34/83161825.jpg","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/83161825.jpg","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/83161825.jpg","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/83161825.jpg","size":"extralarge"}],"attendance":"0","reviews":"0","tag":"lastfm:event=3440164","url":"http://www.last.fm/event/3440164+The+Prestige+at+La+Clef+on+8+December+2012","website":"http://www.laclef.asso.fr/","tickets":"\n  ","cancelled":"0","tags":{"tag":["french","hardcore"]},"@attr":{"status":"2"}},{"id":"3434372","title":"Bring The Noise","score":"0.024926985105034","artists":{"artist":["Mass Hysteria","The Arrs","Rise of the Northstar"],"headliner":"Mass Hysteria"},"venue":{"id":"8781897","name":"Divan du Monde","location":{"geo:point":{"geo:lat":"48.882632","geo:long":"2.339606"},"city":"Paris","country":"France","street":"75 rue des Martyrs","postalcode":"75018"},"url":"http://www.last.fm/venue/8781897+Divan+du+Monde","website":"http://www.divandumonde.com","phonenumber":"+33-(0)1-42 52 02 46","image":[{"#text":"http://userserve-ak.last.fm/serve/34/5492542.png","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/5492542.png","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/5492542.png","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/5492542.png","size":"extralarge"},{"#text":"http://userserve-ak.last.fm/serve/_/5492542/Divan+du+Monde+DDM.png","size":"mega"}]},"startDate":"Sun, 09 Dec 2012 18:37:01","description":"","image":[{"#text":"http://userserve-ak.last.fm/serve/34/154643.jpg","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/154643.jpg","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/154643.jpg","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/154643.jpg","size":"extralarge"}],"attendance":"7","reviews":"0","tag":"lastfm:event=3434372","url":"http://www.last.fm/event/3434372+Bring+The+Noise","website":"","tickets":"\n  ","cancelled":"0","tags":{"tag":["french","hardcore"]},"@attr":{"status":"2"}},{"id":"3420712","title":"Hopes Die Last","score":"0.67192667769729","artists":{"artist":["Hopes Die Last","Alaska","Merge","Our Theory","Dying 69"],"headliner":"Hopes Die Last"},"venue":{"id":"8778861","name":"Batofar","location":{"geo:point":{"geo:lat":"48.833326","geo:long":"2.379248"},"city":"Paris","country":"France","street":"11 Quai François Mauriac","postalcode":"75013"},"url":"http://www.last.fm/venue/8778861+Batofar","website":"http://www.batofar.org","phonenumber":"0971255061","image":[{"#text":"http://userserve-ak.last.fm/serve/34/3067553.jpg","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/3067553.jpg","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/3067553.jpg","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/3067553.jpg","size":"extralarge"},{"#text":"http://userserve-ak.last.fm/serve/500/3067553/Batofar+_1.jpg","size":"mega"}]},"startDate":"Mon, 10 Dec 2012 15:42:01","description":"","image":[{"#text":"http://userserve-ak.last.fm/serve/34/38494927.jpg","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/38494927.jpg","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/38494927.jpg","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/38494927.jpg","size":"extralarge"}],"attendance":"5","reviews":"0","tag":"lastfm:event=3420712","url":"http://www.last.fm/event/3420712+Hopes+Die+Last+at+Batofar+on+10+December+2012","website":"","tickets":"\n  ","cancelled":"0","@attr":{"status":"2"}},{"id":"3338159","title":"Efterklang","score":"0.031390054129458","artists":{"artist":["Efterklang","Mermonte"],"headliner":"Efterklang"},"venue":{"id":"8782227","name":"Café de la Danse","location":{"geo:point":{"geo:lat":"48.853741","geo:long":"2.372818"},"city":"Paris","country":"France","street":"5 passage Louis Philippe","postalcode":"75011"},"url":"http://www.last.fm/venue/8782227+Caf%C3%A9+de+la+Danse","website":"http://cafedeladanse.com","phonenumber":"+33-(0)1-47005759","image":[{"#text":"http://userserve-ak.last.fm/serve/34/37898213.jpg","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/37898213.jpg","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/37898213.jpg","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/37898213.jpg","size":"extralarge"},{"#text":"http://userserve-ak.last.fm/serve/_/37898213/Caf+de+la+Danse+cafedeladanse.jpg","size":"mega"}]},"startDate":"Thu, 13 Dec 2012 22:25:01","description":"<div class=\"bbcode\">Tarif : 18,80 euros<br /><br />Apres 2 ans d'absence, Efterklang revient enfin à Paris !<br /><br /><a href=\"http://www.last.fm/music/Efterklang\" class=\"bbcode_artist\">Efterklang</a> (litteralement ‘apres-bruit’) est un ensemble de dix musiciens internationaux bases a Copenhague. Pour accompagner la musique, Efterklang recrutent alors le videaste Karim Ghahwagi, dont les collages videos font partie integrante des performances live ensorcelantes du groupe. Le personnel est aujourd’hui completé par la trompette de Kristina Schjelde et les cordes de Hildur Arsaelsdottir et Edda Run Olafsdottir du quartet Amina, celebres pour leur superbe travail avec Sigur Ros.<br /><br />Vainqueurs du tremplin des Vieilles Charrues 2012 et du concours Inrocks Lab, rappelant parfois les sonorités de Tortoise, Jim O’ Rourke ou Efterklang, les 10 musiciens de <a href=\"http://www.last.fm/music/Mermonte\" class=\"bbcode_artist\">Mermonte</a> nous feront voguer sur les rivages d’une pop classieuse, intime et insaisissable à l’écriture moderne et sophistiqué. <br /><br />Plus projection du documentaire &quot;AN ISLAND&quot; de Vincent Moon, La Blogothèque) dès 19h00 précises, soyez à l'heure ! <br /><a href=\"http://www.anisland.cc/\" rel=\"nofollow\">http://www.anisland.cc/</a></div>","image":[{"#text":"http://userserve-ak.last.fm/serve/34/81741345.png","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/81741345.png","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/81741345.png","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/81741345.png","size":"extralarge"}],"attendance":"70","reviews":"0","tag":"lastfm:event=3338159","url":"http://www.last.fm/event/3338159+Efterklang+at+Caf%C3%A9+de+la+Danse+on+13+December+2012","website":"http://www.cafedeladanse.com/efterklang/","tickets":"\n  ","cancelled":"0","tags":{"tag":["danish","ambient","post-rock","electronic"]},"@attr":{"status":"2"}},{"id":"3346144","title":"Naive New Beaters","score":"0.032536362459956","artists":{"artist":["Naive New Beaters","Le Vasco"],"headliner":"Naive New Beaters"},"venue":{"id":"8784011","name":"Centre Culturel Paul Bailliart","location":{"geo:point":{"geo:lat":"48.730634","geo:long":"2.283504"},"city":"Massy","country":"France","street":"6, allée de Québec","postalcode":"91300"},"url":"http://www.last.fm/venue/8784011+Centre+Culturel+Paul+Bailliart","website":"http://www.paul-b.fr","phonenumber":"01 69 75 12 80","image":[{"#text":"http://userserve-ak.last.fm/serve/34/3914445.jpg","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/3914445.jpg","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/3914445.jpg","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/3914445.jpg","size":"extralarge"},{"#text":"http://userserve-ak.last.fm/serve/_/3914445/Centre+Culturel+Paul+Bailliart+ccpb.jpg","size":"mega"}]},"startDate":"Sat, 15 Dec 2012 20:30:00","description":"","image":[{"#text":"http://userserve-ak.last.fm/serve/34/3915678.jpg","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/3915678.jpg","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/3915678.jpg","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/3915678.jpg","size":"extralarge"}],"attendance":"6","reviews":"0","tag":"lastfm:event=3346144","url":"http://www.last.fm/event/3346144+Naive+New+Beaters+at+Centre+Culturel+Paul+Bailliart+on+15+December+2012","website":"","tickets":"\n  ","cancelled":"0","tags":{"tag":["french","electronic","nu rave","electro"]},"@attr":{"status":"2"}},{"id":"3373177","title":"Soulwaxmas","score":"0.33124028157086","artists":{"artist":["Soulwax","2 Many DJ's","Kindness","Palmbomen","Mixhell","Mike Simonetti","Ego Troopers","Xavier de Rosnay & Erol Alkan"],"headliner":"Soulwax"},"venue":{"id":"8833522","name":"Grande Halle de la Villette","location":{"geo:point":{"geo:lat":"48.887764","geo:long":"2.38917"},"city":"Paris","country":"France","street":"211, avenue Jean Jaurès","postalcode":"75019"},"url":"http://www.last.fm/venue/8833522+Grande+Halle+de+la+Villette","website":"http://www.villette.com","phonenumber":"01 40 03 75 75","image":[{"#text":"http://userserve-ak.last.fm/serve/34/5493954.png","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/5493954.png","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/5493954.png","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/5493954.png","size":"extralarge"},{"#text":"http://userserve-ak.last.fm/serve/_/5493954/Grande+Halle+de+la+Villette+GHdlV.png","size":"mega"}]},"startDate":"Sat, 15 Dec 2012 23:00:00","description":"<div class=\"bbcode\">2 Many Dj's Live<br />Soulwax<br /><br />x<br /><br />Xavier de Rosnay &amp; Erol Alkan (B2B)<br />Kindness (Live)<br />Mixhell<br />Palmbomen (Live)<br />Mike Simonetti (Italians do it better)<br />Ego Troopers</div>","image":[{"#text":"http://userserve-ak.last.fm/serve/34/359598.jpg","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/359598.jpg","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/359598.jpg","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/359598.jpg","size":"extralarge"}],"attendance":"43","reviews":"0","tag":"lastfm:event=3373177","url":"http://www.last.fm/event/3373177+Soulwaxmas","website":"","tickets":"\n  ","cancelled":"0","tags":{"tag":"electronic"},"@attr":{"status":"2"}},{"id":"3447858","title":"TotorRo","score":"0.87668239701094","artists":{"artist":["TotorRo","Jean Jean","Hier","Man is not a Bird"],"headliner":"TotorRo"},"venue":{"id":"8933501","name":"La Cantine de Belleville","location":{"geo:point":{"geo:lat":"48.860818","geo:long":"2.367256"},"city":"Paris","country":"France","street":"108, boulevard de Belleville","postalcode":"75020"},"url":"http://www.last.fm/venue/8933501+La+Cantine+de+Belleville","website":"http://www.myspace.com/lacantinedebellevillelive","phonenumber":"","image":[{"#text":"","size":"small"},{"#text":"","size":"medium"},{"#text":"","size":"large"},{"#text":"","size":"extralarge"},{"#text":"","size":"mega"}]},"startDate":"Mon, 17 Dec 2012 19:00:00","description":"<div class=\"bbcode\">I SCREAM ASSO présente :<br /><br /><br />Le Lundi 17 Décembre 2012, à La Cantine de Belleville :<br /><br /><br />TOTORRO<br /><br />JEAN JEAN<br /><br />MAN IS NOT A BIRD<br /><br />HIER<br /><br /><br />|| PAF : 5€ en prévente, 7€ sur place<br /><br />Préventes disponibles :<br />- auprès des groupes<br />- à Landscape Rockshop 16 rue Keller – Bastille<br /><br /><br /><br />|| Ouverture des portes : 19h00<br /><br /><br />-----------<br /><br /><br />|| Pour en savoir plus :<br /><br /><br /><br />TOTORRO<br /><br />Genre : Post Rock<br /><br /><a href=\"https://www.facebook.com/pages/TOTORRO/117966698228573\" rel=\"nofollow\">https://www.facebook.com/pages/TOTORRO/117966698228573</a><br /><br /><a href=\"http://totorro.bandcamp.com/\" rel=\"nofollow\">http://totorro.bandcamp.com/</a> <br /><br /><a href=\"http://vimeo.com/36506061\" rel=\"nofollow\">http://vimeo.com/36506061</a><br /><br />TOTORRO est un quatuor rennais exerçant un post rock à la croisée de Mono, The Evpatoria Report et Envy. Après un premier EP sorti en 2008 qui leur permet de partager l'affiche aux côtés d'As We Draw, Guns Of Brixton, Caspian ou encore Tides From Nebula. Le groupe sort en 2011 son premier album longue durée: &quot;All Glory To John Baltor&quot; chez Tokyo Jupiter Records (Amen Ra, Black Heart Rebellion...). Après une tournée en Europe et quelques dates à nouveau aux côtés de CASPIAN ils repartent en tournée fin 2012 avant de se concentrer sur la sortie de leur prochaine plaque prévue pour 2013!<br /><br /><br /><br />JEAN JEAN<br /><br />Genre : rock ambiant electro-rock<br /><br /><a href=\"http://www.facebook.com/jeanjeanmusic\" rel=\"nofollow\">http://www.facebook.com/jeanjeanmusic</a><br /><br /><a href=\"http://jeanjean.bandcamp.com/\" rel=\"nofollow\">http://jeanjean.bandcamp.com/</a><br /><br /><a href=\"http://vimeo.com/38677670\" rel=\"nofollow\">http://vimeo.com/38677670</a> <br /><br />Jean Jean est un trio rock instrumental frais et sautillant avec une touche de mélancolie mais toujours efficace!<br />Auteur d'un 5 titres entre breaks math-rock et spontanéité dancefloor, le trio a pu déjà partager la scène avec Toe, Marvin, Papier Tigre, Electric Electric, NLF3 ou encore Apes did Ensemble... Sur scène, Jean Jean est une vague d'énergie positive!<br />Pour les fans de BATTLES, Mogwai ou encore Maserati!<br /><br /><br /><br />MAN IS NOT A BIRD<br /><br />Genre : Post Math Rock<br /><br /><a href=\"https://www.facebook.com/manisnotabird\" rel=\"nofollow\">https://www.facebook.com/manisnotabird</a><br /><br /><a href=\"http://manisnotabird.bandcamp.com/album/restlessness-ep\" rel=\"nofollow\">http://manisnotabird.bandcamp.com/album/restlessness-ep</a><br /><br /><a href=\"http://vimeo.com/48033146\" rel=\"nofollow\">http://vimeo.com/48033146</a><br /><br />MAN IS NOT A BIRD est une formation fraîchement créée en 2012.<br />Le groupe est constitué d'Adrien à la batterie, Valentin et Julian aux guitares et Julien à la basse. Le groupe vogue entre un univers post-rock et math-rock.<br /><br /><br /><br />HIER<br /><br />Genre : Post Rock<br /><br /><a href=\"https://www.facebook.com/pages/Hier/110459222377197\" rel=\"nofollow\">https://www.facebook.com/pages/Hier/110459222377197</a><br /><br /><a href=\"http://www.hier.bandcamp.com/\" rel=\"nofollow\">http://www.hier.bandcamp.com/</a><br /><br /><a href=\"http://www.youtube.com/watch?v=FGk7jrv1O9I&amp;feature=youtu.be\" rel=\"nofollow\">http://www.youtube.com/watch?v=FGk7jrv1O9I&amp;feature=youtu.be</a><br /><br />Hier est un jeune groupe Essonnien formé en 2011 dont le premier opus, &quot;Rhizomes&quot;, est réalisé en 2012 par leurs propres soins.<br />Le groupe livre une musique oscillant entre ombre et lumière, un post rock/métal alternatif.<br />Pesant, intime et libérateur.<br /><br /><br /><br />La Cantine de Belleville<br /><br />108 Boulevard de Belleville 75020 Paris<br /><br />Métro Belleville (ligne 2 et ligne 11)<br /><br /><br /><br /><br />Partenaires : Landscape Rockshop, Les Gâteaux de Barbara, Visual Music, All The Rage TV, Rock Your Life, Alternativ News, Playsound, Pixiblack, Yeaaah! Studio, Allglorious</div>","image":[{"#text":"http://userserve-ak.last.fm/serve/34/54320539.jpg","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/54320539.jpg","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/54320539.jpg","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/54320539.jpg","size":"extralarge"}],"attendance":"2","reviews":"0","tag":"lastfm:event=3447858","url":"http://www.last.fm/event/3447858+TotorRo+at+La+Cantine+de+Belleville+on+17+December+2012","website":"https://www.facebook.com/events/223201007812003/","tickets":"\n  ","cancelled":"0","tags":{"tag":["math rock","post-rock","instrumental"]},"@attr":{"status":"2"}},{"id":"3422779","title":"Manimal","artists":{"artist":["Manimal","ATLANTIS CHRONICLES","Inner Reflects"],"headliner":"Manimal"},"venue":{"id":"9062856","name":"Glazart","location":{"geo:point":{"geo:lat":"48.899382","geo:long":"2.386851"},"city":"Paris","country":"France","street":"7/15 avenue de la Porte de la Villette","postalcode":"75019"},"url":"http://www.last.fm/venue/9062856+Glazart","website":"http://www.glazart.com","phonenumber":"01 40 36 55 65","image":[{"#text":"http://userserve-ak.last.fm/serve/34/34078787.png","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/34078787.png","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/34078787.png","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/34078787.png","size":"extralarge"},{"#text":"http://userserve-ak.last.fm/serve/_/34078787/Glazart.png","size":"mega"}]},"startDate":"Wed, 19 Dec 2012 18:52:01","description":"","image":[{"#text":"http://userserve-ak.last.fm/serve/34/290467.jpg","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/290467.jpg","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/290467.jpg","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/290467.jpg","size":"extralarge"}],"attendance":"7","reviews":"0","tag":"lastfm:event=3422779","url":"http://www.last.fm/event/3422779+Manimal+at+Glazart+on+19+December+2012","website":"http://www.facebook.com/events/364255616995783/","tickets":"\n  ","cancelled":"0","@attr":{"status":"2"}},{"id":"3286929","title":"Libre à la foret","score":"0.011264601186841","artists":{"artist":"Nosfell","headliner":"Nosfell"},"venue":{"id":"10255983","name":"Théatre national de Chaillot","location":{"geo:point":{"geo:lat":"48.862587","geo:long":"2.288724"},"city":"Paris","country":"France","street":"","postalcode":""},"url":"http://www.last.fm/venue/10255983+Th%C3%A9atre+national+de+Chaillot","website":"","phonenumber":"","image":[{"#text":"","size":"small"},{"#text":"","size":"medium"},{"#text":"","size":"large"},{"#text":"","size":"extralarge"},{"#text":"","size":"mega"}]},"startDate":"Wed, 19 Dec 2012 20:30:00","description":"","image":[{"#text":"http://userserve-ak.last.fm/serve/34/12227033.jpg","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/12227033.jpg","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/12227033.jpg","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/12227033.jpg","size":"extralarge"}],"attendance":"10","reviews":"0","tag":"lastfm:event=3286929","url":"http://www.last.fm/event/3286929+Libre+%C3%A0+la+foret","website":"","tickets":"\n  ","cancelled":"0","tags":{"tag":["math rock","french","experimental","clinically romantic","avantgarde pop","post-revolutionary pop song"]},"@attr":{"status":"2"}},{"id":"3444679","title":"Crossing the Rubicon","score":"0.025021642886579","artists":{"artist":["Crossing the Rubicon","Rat Attack","Youth Avoiders"],"headliner":"Crossing the Rubicon"},"venue":{"id":"9032396","name":"Les Combustibles","location":{"geo:point":{"geo:lat":"48.847412","geo:long":"2.375414"},"city":"Paris","country":"France","street":"14, rue Abel","postalcode":"75012"},"url":"http://www.last.fm/venue/9032396+Les+Combustibles","website":"http://www.myspace.com/lescombustibles","phonenumber":"","image":[{"#text":"http://userserve-ak.last.fm/serve/34/75847642.jpg","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/75847642.jpg","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/75847642.jpg","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/75847642.jpg","size":"extralarge"},{"#text":"http://userserve-ak.last.fm/serve/500/75847642/Les+Combustibles+combustibles.jpg","size":"mega"}]},"startDate":"Thu, 20 Dec 2012 14:21:01","description":"","image":[{"#text":"http://userserve-ak.last.fm/serve/34/82639501.jpg","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/82639501.jpg","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/82639501.jpg","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/82639501.jpg","size":"extralarge"}],"attendance":"5","reviews":"0","tag":"lastfm:event=3444679","url":"http://www.last.fm/event/3444679+Crossing+the+Rubicon+at+Les+Combustibles+on+20+December+2012","website":"http://www.metalorgie.com/news/83835_Crossing-the-Rubicon-sera-a-Paris-le-20-decembre-avec-Rat-Attack-et-Youth-Avoiders-tout-ca","tickets":"\n  ","cancelled":"0","tags":{"tag":"hardcore"},"@attr":{"status":"2"}},{"id":"3417287","title":"Festival Les Aventuriers","score":"0.40029370254434","artists":{"artist":["Naive New Beaters","The Bewitched Hands"],"headliner":"Naive New Beaters"},"venue":{"id":"8899207","name":"Salle Jacques Brel","location":{"geo:point":{"geo:lat":"48.848676","geo:long":"2.477857"},"city":"Fontenay-sous-Bois","country":"France","street":"164, boulevard Gallieni","postalcode":"94120"},"url":"http://www.last.fm/venue/8899207+Salle+Jacques+Brel","website":"http://www.fontenayenscenes.fr/index.php?59","phonenumber":"","image":[{"#text":"","size":"small"},{"#text":"","size":"medium"},{"#text":"","size":"large"},{"#text":"","size":"extralarge"},{"#text":"","size":"mega"}]},"startDate":"Fri, 21 Dec 2012 20:00:00","description":"","image":[{"#text":"http://userserve-ak.last.fm/serve/34/3915678.jpg","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/3915678.jpg","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/3915678.jpg","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/3915678.jpg","size":"extralarge"}],"attendance":"3","reviews":"0","tag":"lastfm:event=3417287","url":"http://www.last.fm/event/3417287+Festival+Les+Aventuriers","website":"http://www.festival-les-aventuriers.com","tickets":"\n  ","cancelled":"0","tags":{"tag":["french","indie","electronic","2010","electro","nu rave","indie pop"]},"@attr":{"status":"2"}},{"id":"3444471","title":"Kavinsky","score":"0.38436466612944","artists":{"artist":["Kavinsky","DSL","Zombie Zombie","DVNO"],"headliner":"Kavinsky"},"venue":{"id":"9166872","name":"La Gaîté Lyrique","location":{"geo:point":{"geo:lat":"48.866846","geo:long":"2.353595"},"city":"Paris","country":"France","street":"3bis rue Papin","postalcode":"75003"},"url":"http://www.last.fm/venue/9166872+La+Ga%C3%AEt%C3%A9+Lyrique","website":"http://www.gaite-lyrique.net","phonenumber":"+33-(0)1-44 78 84 22","image":[{"#text":"http://userserve-ak.last.fm/serve/34/57380185.jpg","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/57380185.jpg","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/57380185.jpg","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/57380185.jpg","size":"extralarge"},{"#text":"http://userserve-ak.last.fm/serve/500/57380185/La+Gat+Lyrique+12052010074443.jpg","size":"mega"}]},"startDate":"Fri, 21 Dec 2012 23:30:00","description":"<div class=\"bbcode\">La fausse-marque HELLO™ invite donc le véritable Kavinsky (DJ), qui, s'il survit devrait sortir son premier à album à l'aube 2013. Attendu comme le messie après l'Apocalyspe après le tube mondial qu'a été Nightcall, sur la bande originale du film Drive. Il nous fera donc certainement goûter en avant-première aux prochaines envolées electro-symphoniques de son album.<br />Pour une soirée fin du monde il était indispensable d'inviter le duo/trio Zombie Zombie (live), qui ont eux, déjà anticipé l'apocalypse avec leur nouvel album &quot;Rituels d'un nouveau monde&quot;. Avec leurs synthé et leur 2 batteries que ils vous feront chavirer danes eaux troubles d'electro-rock atmosphérique.<br />DVNO (DJ) le chevalier noir de l'electro, passera des disques juqu'au bout de la nuit, quant aux 3 frères DSL (DJ) ils vont invoquer tous les rites vaudous antillais qu'il connaissent pour conjurer le mauvais sort.<br /><br />A partir de minuit jusqu'à 5h du matin. Dernière entrée 4h du matin.</div>","image":[{"#text":"http://userserve-ak.last.fm/serve/34/40047005.jpg","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/40047005.jpg","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/40047005.jpg","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/40047005.jpg","size":"extralarge"}],"attendance":"12","reviews":"0","tag":"lastfm:event=3444471","url":"http://www.last.fm/event/3444471+Kavinsky+at+La+Ga%C3%AEt%C3%A9+Lyrique+on+21+December+2012","website":"","tickets":"\n  ","cancelled":"0","tags":{"tag":["french","electronic","electro"]},"@attr":{"status":"2"}},{"id":"3434374","title":"Bring The Noise","score":"0.41206315995237","artists":{"artist":["Royal Republic","Sleeppers","Blackfeet Revolution"],"headliner":"Royal Republic"},"venue":{"id":"8781897","name":"Divan du Monde","location":{"geo:point":{"geo:lat":"48.882632","geo:long":"2.339606"},"city":"Paris","country":"France","street":"75 rue des Martyrs","postalcode":"75018"},"url":"http://www.last.fm/venue/8781897+Divan+du+Monde","website":"http://www.divandumonde.com","phonenumber":"+33-(0)1-42 52 02 46","image":[{"#text":"http://userserve-ak.last.fm/serve/34/5492542.png","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/5492542.png","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/5492542.png","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/5492542.png","size":"extralarge"},{"#text":"http://userserve-ak.last.fm/serve/_/5492542/Divan+du+Monde+DDM.png","size":"mega"}]},"startDate":"Sat, 22 Dec 2012 18:40:01","description":"","image":[{"#text":"http://userserve-ak.last.fm/serve/34/49195271.jpg","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/49195271.jpg","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/49195271.jpg","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/49195271.jpg","size":"extralarge"}],"attendance":"6","reviews":"0","tag":"lastfm:event=3434374","url":"http://www.last.fm/event/3434374+Bring+The+Noise","website":"","tickets":"\n  ","cancelled":"0","tags":{"tag":["rock","french"]},"@attr":{"status":"2"}},{"id":"3361500","title":"Persistence Tour 2013","score":"0.18860279660259","artists":{"artist":["Hatebreed","Agnostic Front","H2O","Neaera","The Acacia Strain","Stick To Your Guns"],"headliner":"Hatebreed"},"venue":{"id":"8778673","name":"Bataclan","location":{"geo:point":{"geo:lat":"48.863113","geo:long":"2.371051"},"city":"Paris","country":"France","street":"50, boulevard Voltaire","postalcode":"75011"},"url":"http://www.last.fm/venue/8778673+Bataclan","website":"http://www.le-bataclan.com","phonenumber":"+ 33 1 43 14 00 30","image":[{"#text":"http://userserve-ak.last.fm/serve/34/2152188.jpg","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/2152188.jpg","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/2152188.jpg","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/2152188.jpg","size":"extralarge"},{"#text":"http://userserve-ak.last.fm/serve/_/2152188/Bataclan.jpg","size":"mega"}]},"startDate":"Sun, 13 Jan 2013 08:48:01","description":"","image":[{"#text":"http://userserve-ak.last.fm/serve/34/64013733.jpg","size":"small"},{"#text":"http://userserve-ak.last.fm/serve/64/64013733.jpg","size":"medium"},{"#text":"http://userserve-ak.last.fm/serve/126/64013733.jpg","size":"large"},{"#text":"http://userserve-ak.last.fm/serve/252/64013733.jpg","size":"extralarge"}],"attendance":"43","reviews":"0","tag":"lastfm:event=3361500","url":"http://www.last.fm/event/3361500+Persistence+Tour+2013","website":"http://persistencetour.de/pages/main.html","tickets":"\n  ","cancelled":"0","tags":{"tag":["hardcore","metalcore"]},"@attr":{"status":"2"}}],"@attr":{"user":"roly","page":"1","perPage":"20","totalPages":"3","total":"49","festivalsonly":"0"}}};

app.get('/gigs', function(req, res) {
  try {
    var sk = req.cookies.gigfm_sk || req.query["sk"];
    console.log("sk", sk, req.cookies);
    if (sk)
      lastfm.fetchRecommendedGigs(sk, function(gigs) {
        //res.json(gigs);
        renderAppPage(req, res, "gigs.ejs", { gigs: gigs });
      });
    else
        renderAppPage(req, res, "gigs.ejs", { gigs: sampleGigs });
  }
  catch (e) {
    res.redirect("/");
  }
});

function parseEvent(event, cb) {
  self.name = event.title;
  self.date = new Date(event.startDate);
  self.desc = event.description;
  self.url = event.website || event.url;
  if (event.tags && event.tags.tag)
    self.tags = event.tags.tag;
  if (event.image) {
    //console.log(typeof event.image, event.image)
    if (typeof event.image == "string")
      self.img = event.image;
    else
      for(var i=0; i<event.image.length; ++i)
        self.img = event.image[i]["#text"];
  }
  if (event.venue) {
    self.venue = {
      id: event.venue.id,
      name: event.venue.name,
      url: event.venue.website || event.venue.url,
    };
    if (event.venue.location) {
      self.venue.city = event.venue.location.city;
      self.venue.street = event.venue.location.street;
      self.venue.country = event.venue.location.country;
      self.venue.postalcode = event.venue.location.postalcode;
      if (event.venue.location["geo:point"])
        self.venue.latlng = [
          event.venue.location["geo:point"]["geo:lat"],
          event.venue.location["geo:point"]["geo:long"]
        ];
    }
  }
  if (typeof event.artists.artist == "string")
    self.artists = [
      new lastfm.LastfmArtist(event.artists.artist)
    ];
  else
    self.artists = event.artists.artist.map(function(name, i){
      return new lastfm.LastfmArtist(name);
    });
  cb(self);
}



function prepareEvent(req, cb) {
  var gId = req.url.split("?")[0];
  console.log("prepare event", gId);
  var p = {
    title: APP.name,
    url: APP.url + req.url,
    img: APP.img
  };
  lastfm.fetchGig(gId, function(gig){
    console.log("last fm gig:", gig);
    if (gig && gig.event) {
      gig = gig.event;
      p.title = gig.title;

      if (gig.image) {
        if (typeof gig.image == "string")
          p.img = gig.image;
        else if (gig.image.length)
          p.img = gig.image[gig.image.length-1]["#text"];
      }
      if (gig.venue)
        p.title += " @ " + gig.venue.name;
    }
    cb({page:p});
  });
}

app.get('/event/*', makeRenderer("event.ejs", prepareEvent));
app.get('/festival/*', makeRenderer("event.ejs", prepareEvent));

app.get('/test', function(req, res) {
  lastfm.getTopTracks("cher", function(json){
    res.json(json); 
  });
});

